# プロット
## 前提

本学習を行うにあたっての前提を定義する。
- CPUはIntel それに伴い、x86-64を前提とする。
- gccのバージョンは　x86-64 gcc8.1

## アセンブリとは
- アセンブリとは低級言語(低水準言語)
- 機械語とアセンブリは1対1になる

### 汎用レジスタ

|汎用レジスタ||
|:---:|:---:|
|AX|アキュムレータレジスタ|
|BX|ベースレジスタ|
|CX|カウントレジスタ|
|DX|データレジスタ|

プログラマが自由に使える変数
慣習的にBXにはメモリのアドレスを格納するのに使われる。
CXにはループなどプログラムカウンタとして使われることが多い。
AXには計算結果を格納することが多く、足りなければDXを使うといった形だ。

|インデックスレジスタ||
|:---:|:---:|
|SI|ソースレジスタ|
|DI|ディスティネーションインデックス|

|特殊レジスタ||
|:---:|:---:|
|BP|ベースポインタ|
|SP|スタックポインタ|
|IP|インストラクションポインタ|

|セグメントレジスタ||
|:---:|:---:|
|CS|コードセレクタ|
|DS|データセグメント|
|ES|エクストラセグメント|
|SS|スタックセグメント|

レジスタの基本構造

### アキュムレータレジスタ　RAX
演算結果を格納する。</br>
64bit * 64bitの乗算の結果の下位64bitが格納される。</br>
128bit/64bitの整数除算の場合に被除数の下位64bitが格納される。</br>
Linuxのシステムコール番号の指定に使用</br>
システムコールの結果が格納される。

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||RAX|||||
|||||EAX||||
|||||||AX||
|||||||AH|AL|

### ベースレジスタ　RBX
汎用レジスタ

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||RBX|||||
|||||EBX||||
|||||||BX||
|||||||BH|BL|

### カウンタレジスタ　RCX
繰り返し回数の設定に使う。

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||RCX|||||
|||||ECX||||
|||||||CX||
|||||||CH|CL|

### データレジスタ　RDX
64bit * 64bitの乗算の結果の上位64bitが格納される</br>
128bit / 64bitの整数除算の被除数の上位64bitが格納される。</br>
Linuxのシステムコールの第3引数の設定に使用する。

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||RDX|||||
|||||EDX||||
|||||||DX||
|||||||DH|DL|

### ソースインデックスレジスタ　RSI
ストリング型の命令でコピー元(ソース)を示す場合に使用される。</br>
Linuxのシステムコールの第2引数の設定に使用</br>

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||RSI|||||
|||||ESI||||
|||||||SI||
||||||||SIL|

### デスティネーションインデックスレジスタ　RDI
ストリング型の命令でコピー先(デスティネーション)を示す場合に使用される。</br>
Linuxのシステムコールの第1引数の設定に使用</br>

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||RDI|||||
|||||EDI||||
|||||||DI||
||||||||DIL|

### ベースポインタ　RBP
スタック内のアクセスに使われる。</br>
普通のレジスタとしても利用可能

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||RBP|||||
|||||EBP||||
|||||||BP||
||||||||BPL|

### スタックポインタ　RSP
サブルーチンコールの戻りアドレスを格納する</br>
PUSH, POP命令でレジスタを一時退避、復帰する際に使用する。</br>
ただし、64bitモードの場合、ESP、SP、SPLのように部分的にアクセスすることはない。

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||RSP|||||
|||||ESP||||
|||||||SP||
||||||||SPL|

### 拡張汎用レジスタ　R8-R15
64bitモードで追加された汎用レジスタ</br>
汎用レジスタと同じように使用可能</br>
Linuxのシステムコール呼び出しでは第4引数をR10、第5引数をR8、第6引数をR9に設定する。

|7|6|5|4|3|2|1|0|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
||||R8|||||
|||||R8D||||
|||||||R8W||
||||||||R8B|

### フラグレジスタ　RFFLAGS

いくつかありますが、ここではよく使われるレジスタを紹介します。

OFフラグ：
　オーバーフローフラグ。符号付き演算でオーバーフローが発生した場合、1が設定される。
DFフラグ：
　方向フラグ。文字列操作の方向を示す。(インクリメントかデクリメント)
CF：
　キャリーフラグ。演算で繰り上げ/繰り下げがある場合、1が設定される。
PF：
　パリティフラグ。最下位バイトの1の数が偶数の場合1、そうでない場合、0が設定される。
ZF：
　ゼロフラグ。演算結果が0の時、1がされる。
SF：
　符号フラグ。結果の最上位のビットが1の場合、1に設定される。


レジスタの前、または後についている1文字で、扱うレジスタのバイト長を表す。

|レジスタ{前,後}置記号|場所|ビット幅|バイト幅|備考|利用例|
|:--:|:--:|:--:|:--:|:--:|:--:|
|h|後|8|1|high|ah|
|l|後|8|1|low|al|
|x|後|16|2|eXtended|ax|
|e|前|32|4|Extended|eax|
|r|前|64|8||rax|

### ニーモニック
ニーモニックの基本形

```
MOV destination, source
```

第一オペランドをデスティネーションオペランド、第二オペランドをソースオペランドという。

命令を表すニーモニックの最後についている一文字で、扱うデータのバイト長を表す。

|命令の後置記号|ビット幅|バイト幅|備考|利用例|
|:--:|:--:|:--:|:--:|:--:|
|b|8|1|byte|movb|
|w|16|2|word|movw|
|l|32|4|long|movl|
|q|64|8|quad|movq|

ただし、Intel記法の場合、ニーモニック上のような後置記号を使ってバイト幅を表記しない。

Intel記法のバイト幅を表現するために記法は以下の通りです。

|命令の後に記述する記号|ビット幅|バイト幅|利用例|
|:--:|:--:|:--:|:--:|
|BYTE PTR|8|1|MOV BYTE PTR|
|WORD PTR|16|2|MOV WORD PTR|
|DWORD PTR|32|4|MOV DWORD PTR|
|QWORD PTR|64|8|MOV QWORD PTR|


### 演算命令
|ニーモニック|命令の動作|
|:--:|:--:|
|ADD|整数加算|
|SUB|整数減算|
|INC|1の加算|
|DEC|1の減算|
|NEG|2の補数|
|AND|ビット毎の論理積|
|OR|ビット毎の論理和|
|XOR|ビット毎の排他的論理和|
|NOT|ビットの反転|
|MUL|符号なし整数乗算|
|IMUL|符号付き数の整数乗算|
|DIV|符号なし整数除算|
|IDIV|符号付き数の整数除算|
|CMP|減算による比較|
|TEST|ビット毎の論理積による比較|
|JMP|無条件にジャンプ|
|JE|等しい場合ジャンプ|
|JNE(JLE)|等しくない場合ジャンプ|
|JC|キャリーあり|
|JNC(JLC)|キャリーなし|
|LOOP|ECXを使用するループ|
|CALL|サブルーチンの呼び出し|
|RET|関数のリターン|
|PUSH|スタックにプッシュ|
|POP|スタックから取り出し|
|SAL|左シフト演算|
|SAR|右シフト演算|


### アドレッシング・モード

命令がレジスターやメモリーにアクセスする方法を示します。

|アクセス方法|例|説明|
|:--|:--|:--|
|即値|ADD EAX, 14|32ビットのEAXに14を足す|
|レジスタとレジスタ|ADD R8L, AL|R8Lに8ビットのALを足す|
|間接アドレッシング|MOV R8W, 1234[8*RAX+RCX]|アドレス 8*RAX + RCX + 1234にあるワードをR8Wに格納する|
|RIP相対アドレッシング|MOV AL, [RIP]|RIPは次命令NOPを指す|

## 参考文献

https://www.mztn.org/lxasm64/amd04.html</br>
https://www.isus.jp/others/introduction-to-x64-assembly/